{%- assign selected_variant = product.selected_or_first_available_variant -%}

<div class="card {% if product.media.size > 0 %}card--collapsed{% endif %} {% if template.name == 'product' %}card--sticky{% endif %}">
  {%- if section.settings.enable_image_zoom -%}
    <div id="product-zoom-{{ section.id }}" class="product__zoom-wrapper"></div>
  {%- endif -%}

  <div class="card__section">
    <product-form>
      {%- form 'product', product, id: product_form_id, class: 'product-form' -%}
        {%- for block in section.blocks -%}
          {%- capture block_content -%}
            {%- case block.type -%}

              {%- when 'separator' -%}
                {%- render 'card-separator' -%}

              {%- when 'product_meta' -%}
                {%- render 'product-meta', product: product, block: block, update_url: update_url -%}

              {%- when 'variant_selector' -%}
                {%- render 'product-variant-selector', product: product, product_form_id: product_form_id, update_url: update_url, block: block -%}

              {%- when 'product_info_list' -%}
                {%- render 'product-info-list', product: product, product_form_id: product_form_id, update_url: update_url, block: block -%}

              {%- when 'product_price' -%}
                {%- render 'product-price', product: product, product_form_id: product_form_id, update_url: update_url, block: block -%}

              {%- when 'volume_pricing' -%}
                {%- render 'volume-pricing-table', variant: product.selected_or_first_available_variant -%}

              {%- when 'buy_buttons' -%}
                {%- render 'product-buy-buttons', product: product, form: form, block: block -%}

               {%- assign vp_block = section.blocks | where: 'type', 'value_props' | first -%}
                {%- if vp_block -%}
                  {% render 'value-props', block: vp_block %}
                {%- endif -%}


              {% when 'bundle_summary' %}
                {% if template.suffix == 'bundles' %}
                  {% render 'bundle-summary-card', block: block %}
                {% endif %}

              {%- when 'value_props' -%}
                <div
                  class="product-block-list__item product-block-list__item--value-props"
                  {{ block.shopify_attributes }}
                >
                  {% render 'value-props', block: block %}
                </div>

              {%- when 'text' -%}
                {%- if block.settings.content != blank -%}
                  <div class="product-meta__text rte">
                    {{- block.settings.content -}}
                  </div>
                {%- endif -%}

              {%- when 'button' -%}
                {%- if block.settings.text != blank -%}
                  <a href="{{ block.settings.link }}" class="product-meta__button button button--primary">{{ block.settings.text | escape }}</a>
                {%- endif -%}

              {%- when 'store_pickup' -%}
                <div class="product-meta__store-availability-container">
                  {%- render 'store-availability', product_variant: product.selected_or_first_available_variant -%}
                </div>

              {%- when 'featured_description' -%}
                {%- if product.description != blank -%}
                  <div class="product-meta__description rte">
                    {{ product.description | remove: 'data-section-type="product"' }}
                  </div>
                {%- endif -%}

              {%- when '@app' -%}
                {%- comment -%}Only show app blocks on main product page, not in quick view{%- endcomment -%}
                {%- if update_url == true -%}
                  <div class="the-app-wrapper loading">
                    {%- render block -%}
                  </div>
                {%- endif -%}

            {%- endcase -%}
          {%- endcapture -%}

          <div
            class="product-info__block-item product-info__block-item--{{ block.type | replace: '_', '-' }}"
            data-block-id="{{ block.id }}"
            data-block-type="{{ block.type | replace: '_', '-' }}"
            {% unless block.type == '@app' or block.type == 'accordion' %}
              {{- block.shopify_attributes -}}
            {% endunless %}
          >
            {{- block_content -}}
          </div>
        {%- endfor -%}

        {%- assign product_meta_block = section.blocks | where: 'type', 'product_meta' | first -%}

        {%- if product_meta_block != blank and product_meta_block.settings.show_share_buttons -%}
          <div class="product-meta__share-buttons hidden-tablet-and-up">
            <span class="text--strong">{{ 'product.general.share' | t }}</span>

            {%- assign share_url = shop.url | append: product.url | url_param_escape -%}
            {%- assign twitter_text = product.title | url_param_escape -%}
            {%- assign pinterest_description = product.description
              | strip_html
              | truncatewords: 15
              | url_param_escape
            -%}
            {%- assign pinterest_image = product.featured_media | img_url: '1024x' | prepend: 'https:' -%}

            <ul class="social-media__item-list list--unstyled" role="list">
              <li class="social-media__item social-media__item--facebook">
                <a
                  href="https://www.facebook.com/sharer.php?u={{ share_url }}"
                  target="_blank"
                  rel="noopener"
                  aria-label="{{ 'general.social.facebook_share' | t }}"
                >
                  {%- render 'icon', icon: 'facebook' -%}
                </a>
              </li>
              <li class="social-media__item social-media__item--pinterest">
                <a
                  href="https://pinterest.com/pin/create/button/?url={{ share_url }}{% if pinterest_image != blank %}&media={{ pinterest_image }}{% endif %}&description={{ pinterest_description }}"
                  target="_blank"
                  rel="noopener"
                  aria-label="{{ 'general.social.pinterest_pin' | t }}"
                >
                  {%- render 'icon', icon: 'pinterest' -%}
                </a>
              </li>
              <li class="social-media__item social-media__item--twitter">
                <a
                  href="https://twitter.com/intent/tweet?{% if twitter_text != blank %}text={{twitter_text}}&{% endif %}url={{ share_url }}"
                  target="_blank"
                  rel="noopener"
                  aria-label="{{ 'general.social.twitter_tweet' | t }}"
                >
                  {%- render 'icon', icon: 'twitter' -%}
                </a>
              </li>
              <li class="social-media__item">
                <a
                  href="mailto:?&subject={{ product.title | escape }}&body={{ share_url }}"
                  aria-label="{{ 'general.social.email_share' | t }}"
                >
                  {%- render 'icon', icon: 'email' -%}
                </a>
              </li>
            </ul>
          </div>
        {%- endif -%}
      {%- endform -%}
    </product-form>
  </div>
</div>

{%- comment -%}Only include inventory tracking script on main product pages, not quick view{%- endcomment -%}
{%- if template.name == 'product' and update_url == true -%}
<script>
(function(){
  var SECTION_ID = '{{ section.id }}';
  var ctrl = null, ver = 0, debounceT = null;

  function fetchSectionHTML(variantId, version){
    if (ctrl) ctrl.abort();
    ctrl = new AbortController();
    var url = new URL(window.location.href);
    url.searchParams.set('section_id', SECTION_ID);
    if (variantId) url.searchParams.set('variant', String(variantId));
    return fetch(url.toString(), { credentials:'same-origin', signal: ctrl.signal })
      .then(function(r){ return r.text(); })
      .then(function(html){ return { html: html, version: version }; });
  }

  function extract(html, selector){
    var doc = new DOMParser().parseFromString(html, 'text/html');
    return doc.querySelector(selector);
  }

  function recalcInventoryBar(scope){
    var bar = scope.querySelector('.inventory-bar');
    if (!bar) return;

    var inv = parseFloat(bar.getAttribute('data-variant-inventory')) || 0;
    var max = parseFloat(bar.getAttribute('data-stock-countdown-max')) || 0;
    var pct = max > 0 ? Math.max(0, Math.min(100, (inv / max) * 100)) : 0;

    var prog = bar.querySelector('.inventory-bar__progress');
    if (!prog) return;

    var old = prog.style.transition;
    prog.style.transition = 'none';
    prog.style.width = Math.round(pct) + '%';
    requestAnimationFrame(function(){
      prog.style.transition = old || 'width 1.15s ease-in-out';
    });
  }

  function swapInventory(html, version){
    if (version !== ver) return;

    var section = document.getElementById('shopify-section-{{ section.id }}') || document;
    var current  = section.querySelector('.product-info__block-item[data-block-type="product-info-list"]');
    var incoming = extract(html, '.product-info__block-item[data-block-type="product-info-list"]');
    if (!current || !incoming) return;

    current.innerHTML = incoming.innerHTML;
    recalcInventoryBar(current);
    try { document.dispatchEvent(new Event('product:rerendered')); } catch(_) {}
  }

  function schedule(variantId){
    clearTimeout(debounceT);
    debounceT = setTimeout(function(){
      ver += 1;
      var v = ver;
      fetchSectionHTML(variantId, v)
        .then(function(p){ swapInventory(p.html, p.version); })
        .catch(function(){});
    }, 60);
  }

  function onVariant(e){
    var v = e && e.detail && e.detail.variant;
    if (v && v.id) schedule(v.id);
  }


  document.addEventListener('product:variant:change', onVariant);
  document.addEventListener('variant:changed', onVariant);


  document.addEventListener('DOMContentLoaded', function(){
    var vid = new URLSearchParams(location.search).get('variant');
    if (vid) schedule(vid);
  });
})();
</script>
{%- endif -%}
