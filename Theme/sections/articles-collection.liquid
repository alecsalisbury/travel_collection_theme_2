{%- assign blog = section.settings.blog -%}

{% unless section.settings.hide_on_url_contains != blank and request.path contains section.settings.hide_on_url_contains %}
<style>
  @media screen and (min-width: 641px) {
    #shopify-section-{{ section.id }} .section__title {
      font-size: {{ section.settings.title_font_size }}px;
    }
    
    #shopify-section-{{ section.id }} .section__header-link .link {
      font-size: {{ section.settings.view_all_font_size }}px;
      font-weight: bold;
    }
  }

  {% if section.settings.title_font_family == "condensed" %}
    #shopify-section-{{ section.id }} .section__title {
      font-family: "Roboto Condensed", sans-serif;
    }
  {% endif %}
  
  {% if section.settings.view_all_font_family == "condensed" %}
    #shopify-section-{{ section.id }} .section__header-link .link {
      font-family: "Roboto Condensed", sans-serif;
    }
  {% endif %}
</style>

<section class="section tab-articles" data-section-id="{{ section.id }}" data-section-type="articles-collection">
  <div class="container">
    {%- if section.settings.title != blank -%}
      <header class="section__header section__header--with-link">
        <h2 class="section__title heading h3">{{ section.settings.title | escape }}</h2>
        {%- if section.settings.view_all_text != blank -%}
          <div class="section__header-link">
            {%- if section.settings.tag == blank -%}
              <a href="{{ blog.url }}" class="link link--accented">
                {{ section.settings.view_all_text }}
                <svg class="icon icon--arrow-right" viewBox="0 0 8 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="m5 1 2 2-2 2M1 3h6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            {%- else -%}
              <a href="{{ blog.url }}/tagged/{{ section.settings.tag | handle }}" class="link link--accented">
                {{ section.settings.view_all_text }}
                <svg class="icon icon--arrow-right" viewBox="0 0 8 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="m5 1 2 2-2 2M1 3h6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            {%- endif -%}
          </div>
        {%- endif -%}
      </header>
    {%- endif -%}

    <!-- Articles Content -->
    <div class="tab-articles__content">
      <div class="tab-articles__panel is-active">
        {%- capture article_list -%}
          {%- assign articles_to_show = section.settings.articles_per_collection | default: 6 -%}
          {%- assign articles_count = 0 -%}
          {%- assign has_articles = false -%}
          {%- assign displayed_articles = 0 -%}
          
          {%- if section.settings.tag == blank -%}
            {%- assign displayed_articles = blog.articles.size | at_most: articles_to_show -%}
            {%- assign articles_count = blog.articles.size -%}
          {%- else -%}
            {%- for article in blog.articles -%}
              {%- if article.tags contains section.settings.tag -%}
                {%- assign articles_count = articles_count | plus: 1 -%}
                {%- if displayed_articles < articles_to_show -%}
                  {%- assign displayed_articles = displayed_articles | plus: 1 -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          <div class="article-list article-list--horizontal {% if displayed_articles > 3 %}article-list--slider{% endif %}">
            {%- if section.settings.tag == blank -%}
              {%- comment -%} Show all articles if no tag is specified {%- endcomment -%}
              {%- for article in blog.articles limit: articles_to_show -%}
                {%- assign has_articles = true -%}
                <div class="article-list__item">
                  {%- render 'article-item', article: article, featured: false -%}
                </div>
              {%- endfor -%}
            {%- else -%}
              {%- comment -%} Filter by specific tag using contains {%- endcomment -%}
              {%- assign displayed_count = 0 -%}
              {%- for article in blog.articles -%}
                {%- if article.tags contains section.settings.tag -%}
                  {%- if displayed_count < articles_to_show -%}
                    {%- assign has_articles = true -%}
                    <div class="article-list__item">
                      {%- render 'article-item', article: article, featured: false -%}
                    </div>
                    {%- assign displayed_count = displayed_count | plus: 1 -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            
            {%- unless has_articles -%}
              <div class="tab-articles__empty">
                <p class="text--subdued">{{ 'blog.general.empty' | t }}</p>
              </div>
            {%- endunless -%}
          </div>
        {%- endcapture -%}

        {%- if has_articles -%}
          <div class="scroller">
            <div class="scroller__inner">
              {{ article_list }}
            </div>
          </div>
        {%- else -%}
          {{ article_list }}
        {%- endif -%}

      </div>
    </div>
  </div>
</section>

{{ 'tab-articles.css' | asset_url | stylesheet_tag }}
{% endunless %}

{% schema %}
{
  "name": "Articles Collection",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog",
      "info": "Select the blog to display articles from"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Latest Posts"
    },
    {
      "type": "range",
      "id": "title_font_size",
      "min": 12,
      "max": 84,
      "step": 2,
      "unit": "px",
      "label": "Title size",
      "default": 32
    },
    {
      "type": "select",
      "id": "title_font_family",
      "label": "Title font family",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "condensed",
          "label": "Condensed"
        }
      ],
      "default": "normal"
    },
    {
      "type": "text",
      "id": "tag",
      "label": "Tag",
      "info": "Enter the exact tag name to filter articles by. Leave empty to show all articles. Case sensitive.",
      "placeholder": "e.g. Fly Fishing Travel"
    },
    {
      "type": "range",
      "id": "articles_per_collection",
      "label": "Articles to show",
      "min": 3,
      "max": 12,
      "step": 1,
      "default": 6
    },
    {
      "type": "checkbox",
      "id": "show_category",
      "label": "Show category",
      "info": "The first article's tag will be shown as category.",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_author",
      "label": "Show author",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_date",
      "label": "Show date",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_excerpt",
      "label": "Show excerpt",
      "default": false
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View all link text",
      "default": "VIEW ALL",
      "info": "Leave empty to hide the link"
    },
    {
      "type": "range",
      "id": "view_all_font_size",
      "min": 8,
      "max": 32,
      "step": 1,
      "unit": "px",
      "label": "View all link size",
      "default": 14
    },
    {
      "type": "select",
      "id": "view_all_font_family",
      "label": "View all link font family",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "condensed",
          "label": "Condensed"
        }
      ],
      "default": "normal"
    },
    {
      "type": "text",
      "id": "hide_on_url_contains",
      "label": "Hide when URL contains",
      "info": "Enter text to hide this section when the URL contains that text. Leave blank to disable."
    }
  ],
  "presets": [
    {
      "name": "Articles Collection",
      "category": "Blog",
      "settings": {
        "blog": "news",
        "title": "Latest Posts",
        "tag": ""
      }
    }
  ]
}
{% endschema %}
