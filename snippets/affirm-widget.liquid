{% comment %}
  Affirm Official Widget
  Uses Affirm's built-in promotional messaging widget
  Automatically fetches and displays accurate monthly payments from Affirm's API
{% endcomment %}

{%- assign selected_variant = product.selected_or_first_available_variant -%}
{%- assign price = selected_variant.price -%}

<style>
  .affirm-skeleton {
    display: inline-block;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: affirm-skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 4px;
    height: 20px;
    width: 300px;
  }

  @keyframes affirm-skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .affirm-skeleton-container {
    min-height: 24px;
  }

  .affirm-skeleton-container.loaded .affirm-skeleton {
    display: none;
  }

  /* Fix for Affirm logo rendering */
  .__affirm-logo {
    display: inline-block !important;
    vertical-align: middle !important;
  }

  .__affirm-logo svg {
    display: inline-block !important;
    height: auto !important;
  }
</style>

<div class="affirm-widget-container" style="margin: 12px 0;">
  {%- comment -%}
    Skeleton loader - shown until Affirm widget loads
  {%- endcomment -%}
  <div class="affirm-skeleton-container" id="affirm-skeleton-container">
    <div class="affirm-skeleton"></div>
  </div>

  {%- comment -%}
    Affirm's official promotional messaging widget
    - Automatically displays accurate monthly payment from Affirm's API
    - Updates when affirm.ui.refresh() is called
  {%- endcomment -%}
  <p class="affirm-as-low-as"
     data-page-type="product"
     data-amount="{{ price }}"
     data-affirm-color="blue"
     data-learnmore-show="false">
  </p>

  {%- comment -%}
    "Check your purchasing power" link (hidden)
    To show: change display: none to display: inline-block
  {%- endcomment -%}
  <a class="affirm-check-power-link"
     href="#"
     onclick="affirm.ui.ready(function() { affirm.ui.prequal.show({ amount: {{ price }} }); }); return false;"
     style="display: none; margin-top: 4px; color: #08c; font-size: inherit; text-decoration: none; cursor: pointer;"
     onmouseover="this.style.textDecoration='underline'"
     onmouseout="this.style.textDecoration='none'"
     aria-label="Check your purchasing power - Learn more about Affirm Financing (opens in modal)">
    Check your purchasing power
  </a>
</div>

<script>
(function() {
  console.log('[AFFIRM WIDGET] Initialized with price:', {{ price }});

  var refreshTimer = null;
  var lastPrice = {{ price }};
  var isRefreshing = false;
  var hasListeners = false;

  // Hide skeleton once Affirm content loads
  function hideSkeleton() {
    var skeleton = document.getElementById('affirm-skeleton-container');
    if (skeleton) {
      skeleton.classList.add('loaded');
    }
  }

  // Check if Affirm widget has rendered content
  function checkAffirmLoaded() {
    var widget = document.querySelector('.affirm-as-low-as');
    if (widget && (widget.children.length > 0 || widget.textContent.trim() !== '')) {
      hideSkeleton();
      return true;
    }
    return false;
  }

  // Poll for Affirm to finish loading
  var loadCheckAttempts = 0;
  var loadCheckInterval = setInterval(function() {
    loadCheckAttempts++;

    if (checkAffirmLoaded()) {
      clearInterval(loadCheckInterval);
      console.log('[AFFIRM WIDGET] Content loaded, hiding skeleton');
    } else if (loadCheckAttempts >= 50) {
      // Timeout after 5 seconds (50 * 100ms)
      clearInterval(loadCheckInterval);
      hideSkeleton();
      console.log('[AFFIRM WIDGET] Load check timeout');
    }
  }, 100);

  // Debounced refresh to prevent multiple rapid calls
  function debounceRefresh(newPrice) {
    // Skip if already refreshing
    if (isRefreshing) {
      return;
    }

    // Skip if price hasn't changed
    if (newPrice === lastPrice) {
      return;
    }

    // Clear any pending refresh
    if (refreshTimer) {
      clearTimeout(refreshTimer);
    }

    // Schedule refresh
    refreshTimer = setTimeout(function() {
      isRefreshing = true;
      lastPrice = newPrice;

      if (window.affirm && window.affirm.ui && window.affirm.ui.refresh) {
        affirm.ui.ready(function() {
          affirm.ui.refresh();
          console.log('[AFFIRM WIDGET] Refreshed for price:', newPrice);

          // Reset flag after a delay
          setTimeout(function() {
            isRefreshing = false;
          }, 500);
        });
      } else {
        isRefreshing = false;
      }

      refreshTimer = null;
    }, 200); // Wait 200ms before refreshing
  }

  // Update Affirm widget when variant changes
  function updateAffirmWidget(newPrice) {
    // Update the affirm-as-low-as element
    var affirmWidget = document.querySelector('.affirm-as-low-as');
    if (affirmWidget) {
      affirmWidget.setAttribute('data-amount', newPrice);
    }

    // Update the prequal link
    var prqualLink = document.querySelector('.affirm-check-power-link');
    if (prqualLink) {
      prqualLink.onclick = function() {
        affirm.ui.ready(function() {
          affirm.ui.prequal.show({ amount: newPrice });
        });
        return false;
      };
    }

    // Debounced refresh
    debounceRefresh(newPrice);
  }

  // Set up listeners only once
  if (!hasListeners) {
    hasListeners = true;

    // Variant change handler
    var variantHandler = function(e) {
      if (e.detail && e.detail.variant && e.detail.variant.price) {
        updateAffirmWidget(e.detail.variant.price);
      }
    };

    document.addEventListener('variant:changed', variantHandler, { once: false });
    document.addEventListener('product:variant:change', variantHandler, { once: false });

    // Re-initialize after DOM changes (heavily debounced)
    var rerenderCount = 0;
    document.addEventListener('product:rerendered', function() {
      rerenderCount++;
      if (rerenderCount > 1) {
        // Skip if this is a duplicate event
        return;
      }

      setTimeout(function() {
        rerenderCount = 0;
      }, 1000);

      debounceRefresh(lastPrice);
    });
  }
})();
</script>