{% comment %}
  Custom Affirm Message
  Fast-loading alternative to Affirm app block
  Triggers Affirm modal on click
{% endcomment %}

{%- assign selected_variant = product.selected_or_first_available_variant -%}
{%- assign price = selected_variant.price -%}
{%- assign installment = price | divided_by: 4 -%}

<style>
  /* Hide the slow-loading Affirm app block */
  .product-info__block-item[data-block-id*="affirm"],
  .product-info__block-item--shopify-app-block[data-block-type="shopify-app-block"]:has(.the-app-wrapper) {
    display: none !important;
  }

  /* More specific targeting for Affirm */
  [data-block-id="affirm_pay_over_time_messaging_product_block_hdP8mr"] {
    display: none !important;
  }

  .custom-affirm-message {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 12px 0;
    font-size: 14px;
    line-height: 1.5;
    cursor: pointer;
  }

  .custom-affirm-message:hover .custom-affirm-message__logo-text {
    text-decoration: underline;
  }

  .custom-affirm-message__text {
    color: #333;
  }

  .custom-affirm-message__price {
    font-weight: 600;
  }

  .custom-affirm-message__logo {
    display: inline-block;
    margin-left: 2px;
  }

  .custom-affirm-message__logo-text {
    color: #0FA0EA;
    font-weight: 700;
    text-decoration: none;
  }
</style>

<div class="custom-affirm-message" data-product-price="{{ price }}" onclick="openAffirmModal(event)">
  <span class="custom-affirm-message__text">
    or 4 interest-free payments of
    <span class="custom-affirm-message__price">{{ installment | money }}</span>
    with
  </span>
  <span class="custom-affirm-message__logo">
    <svg width="60" height="18" viewBox="0 0 240 72" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M120.7 39.3h-8.8l4.4-11.4 4.4 11.4zm-4.4-23.7L102.7 48h7.9l2.3-6.1h12l2.3 6.1h8L121.6 15.6h-5.3z" fill="#0FA0EA"/>
      <path d="M148.3 22.2h-7.5v7.5h7.5v-7.5zm0 10.3h-7.5V48h7.5V32.5z" fill="#0FA0EA"/>
      <path d="M166.4 22.2h-7.5V48h7.5V34.8c0-3.6 2.4-5.9 5.9-5.9.7 0 1.4.1 2 .3v-7.1c-.5-.1-1-.2-1.6-.2-3.4 0-5.9 1.9-6.3 5.4v-5.1z" fill="#0FA0EA"/>
      <path d="M198.8 22.2v3.1c-1.5-2.3-4.3-3.7-7.4-3.7-6.6 0-11.8 5.6-11.8 13.4s5.2 13.4 11.8 13.4c3.1 0 5.9-1.4 7.4-3.7V48h7.5V22.2h-7.5zm-5.9 19c-3.8 0-6.7-3-6.7-6.9s2.9-6.9 6.7-6.9 6.7 3 6.7 6.9-2.9 6.9-6.7 6.9z" fill="#0FA0EA"/>
      <path d="M239.9 22.2v3.1c-1.5-2.3-4.3-3.7-7.4-3.7-6.6 0-11.8 5.6-11.8 13.4s5.2 13.4 11.8 13.4c3.1 0 5.9-1.4 7.4-3.7V48H240V22.2h-7.5zm-5.9 19c-3.8 0-6.7-3-6.7-6.9s2.9-6.9 6.7-6.9 6.7 3 6.7 6.9-2.9 6.9-6.7 6.9z" fill="#0FA0EA"/>
      <path d="M84.1 22.2h-7.5V48h7.5V34.2c0-3.4 2.6-5.8 6-5.8 3.4 0 6 2.4 6 5.8V48h7.5V32.5c0-6.8-4.8-11-11.2-11-3.3 0-6.3 1.4-8.3 3.7v-3z" fill="#0FA0EA"/>
      <path d="M57.6 29.4V22c-1.1-.3-2.2-.4-3.3-.4-3.6 0-6.7 1.6-8.5 4.3v-3.7h-7.5V48h7.5V35.3c0-4.5 2.9-7.3 7.4-7.3 1.5 0 2.9.2 4.4.4z" fill="#0FA0EA"/>
      <path d="M65.4 13.6h-7.5V48h7.5V13.6z" fill="#0FA0EA"/>
      <circle cx="32.7" cy="35" r="32.7" fill="#0FA0EA"/>
      <path d="M32.7 13.6c-11.8 0-21.4 9.6-21.4 21.4s9.6 21.4 21.4 21.4 21.4-9.6 21.4-21.4-9.6-21.4-21.4-21.4zm0 35.3c-7.7 0-13.9-6.2-13.9-13.9S25 21.1 32.7 21.1s13.9 6.2 13.9 13.9-6.2 13.9-13.9 13.9z" fill="#fff"/>
      <path d="M32.7 25.8c-5.1 0-9.2 4.1-9.2 9.2s4.1 9.2 9.2 9.2 9.2-4.1 9.2-9.2-4.1-9.2-9.2-9.2zm4.6 11.6h-2v2h-2.6v-2h-4v-2.4l4-6.6h2.6v6.6h2v2.4zm-4.6-2.4v-3.3l-2 3.3h2z" fill="#fff"/>
    </svg>
  </span>
</div>

<script>
  function openAffirmModal(e) {
    e.preventDefault();

    // Try to trigger Affirm's native modal if it exists
    if (window.affirm && window.affirm.ui && window.affirm.ui.error && window.affirm.ui.error.modal) {
      // Affirm modal for promotional messaging
      if (window.affirm.ui.ready) {
        window.affirm.ui.ready(function() {
          affirm.ui.error.modal({
            message: 'Pay over time with Affirm',
            learn_more_url: 'https://www.affirm.com/how-it-works'
          });
        });
      }
    } else {
      // Fallback: open Affirm how-it-works page
      window.open('https://www.affirm.com/how-it-works', '_blank', 'noopener,noreferrer');
    }
  }

  // Update price when variant changes
  document.addEventListener('variant:changed', function(e) {
    if (e.detail && e.detail.variant && e.detail.variant.price) {
      const newPrice = e.detail.variant.price;
      const installment = Math.floor(newPrice / 4);

      const priceElement = document.querySelector('.custom-affirm-message__price');
      if (priceElement) {
        // Format as money
        const formatted = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: '{{ shop.currency }}'
        }).format(installment / 100);

        priceElement.textContent = formatted;
      }

      const messageElement = document.querySelector('.custom-affirm-message');
      if (messageElement) {
        messageElement.setAttribute('data-product-price', newPrice);
      }
    }
  });
</script>
