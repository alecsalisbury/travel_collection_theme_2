{% comment %}
  Custom Affirm Message
  Fast-loading alternative to Affirm app block
  Triggers Affirm modal on click
{% endcomment %}

{%- assign selected_variant = product.selected_or_first_available_variant -%}
{%- assign price = selected_variant.price -%}
{%- assign installment = price | divided_by: 4 -%}

<style>
  /* Hide the slow-loading Affirm app block */
  .product-info__block-item[data-block-id*="affirm"],
  .product-info__block-item--shopify-app-block[data-block-type="shopify-app-block"]:has(.the-app-wrapper) {
    display: none !important;
  }

  /* More specific targeting for Affirm */
  [data-block-id="affirm_pay_over_time_messaging_product_block_hdP8mr"] {
    display: none !important;
  }

  .custom-affirm-message {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 12px 0;
    font-size: 14px;
    line-height: 1.5;
    cursor: pointer;
  }

  .custom-affirm-message:hover .custom-affirm-message__logo-text {
    text-decoration: underline;
  }

  .custom-affirm-message__text {
    color: #333;
  }

  .custom-affirm-message__price {
    font-weight: 600;
  }

  .custom-affirm-message__logo {
    display: inline-block;
    margin-left: 2px;
  }

  .custom-affirm-message__logo-text {
    color: #0FA0EA;
    font-weight: 700;
    text-decoration: none;
  }
</style>

<div class="custom-affirm-message" data-product-price="{{ price }}" onclick="openAffirmModal(event)">
  <span class="custom-affirm-message__text">
    or 4 interest-free payments of
    <span class="custom-affirm-message__price">{{ installment | money }}</span>
    with
    <span class="custom-affirm-message__logo-text">Affirm</span>
  </span>
</div>

<script>
  function openAffirmModal(e) {
    e.preventDefault();

    // Get current product price
    const priceElement = document.querySelector('.custom-affirm-message');
    const price = priceElement ? priceElement.getAttribute('data-product-price') : 0;

    // Try to trigger Affirm's native modal if loaded
    if (window.affirm && window.affirm.ui) {
      // Method 1: Try Affirm's promo modal (most common)
      if (typeof window.affirm.ui.error === 'object' && typeof window.affirm.ui.error.modal === 'function') {
        window.affirm.ui.error.modal({
          title: 'Flexible Financing',
          message: 'Pay over time with Affirm',
          type: 'promo'
        });
      }
      // Method 2: Try opening Affirm's info modal with pricing
      else if (typeof window.affirm.ui.ready === 'function') {
        window.affirm.ui.ready(function() {
          // Trigger Affirm modal programmatically
          if (window.affirm.ui.modal) {
            window.affirm.ui.modal.open({
              amount: price,
              type: 'promo'
            });
          } else {
            // Fallback to website
            window.open('https://www.affirm.com/how-it-works', '_blank', 'noopener,noreferrer');
          }
        });
      } else {
        // Affirm is loaded but modal not available - open website
        window.open('https://www.affirm.com/how-it-works', '_blank', 'noopener,noreferrer');
      }
    } else {
      // Affirm not loaded yet - wait a bit and retry, or open website
      setTimeout(function() {
        if (window.affirm && window.affirm.ui) {
          openAffirmModal(e);
        } else {
          window.open('https://www.affirm.com/how-it-works', '_blank', 'noopener,noreferrer');
        }
      }, 500);
    }
  }

  // Update price when variant changes
  document.addEventListener('variant:changed', function(e) {
    if (e.detail && e.detail.variant && e.detail.variant.price) {
      const newPrice = e.detail.variant.price;
      const installment = Math.floor(newPrice / 4);

      const priceElement = document.querySelector('.custom-affirm-message__price');
      if (priceElement) {
        // Format as money
        const formatted = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: '{{ shop.currency }}'
        }).format(installment / 100);

        priceElement.textContent = formatted;
      }

      const messageElement = document.querySelector('.custom-affirm-message');
      if (messageElement) {
        messageElement.setAttribute('data-product-price', newPrice);
      }
    }
  });
</script>
