{"sections":{"main":{"type":"main-product","blocks":{"product_meta":{"type":"product_meta","settings":{"show_vendor":false,"show_sku":false,"show_reviews_badge":false,"show_share_buttons":false}},"yotpo_product_reviews_star_rating_9JAHkD":{"type":"shopify:\/\/apps\/yotpo-product-reviews\/blocks\/star-rating\/eb7dfd7d-db44-4334-bc49-c893b51b36cf","settings":{"product":"{{product}}"}},"bundle_summary_FmEU64":{"type":"bundle_summary","settings":{}},"liquid_ttm9gb":{"type":"liquid","settings":{"title":"⚠️ Please Note:","liquid":"{% if product.title contains 'Video' %}\n  <div class=\"product-disclaimer\">\n    Some products featured in the original video may be outdated or no longer carried by Trident Fly Fishing. In these cases, we’ve substituted the most similar available items. Please note that this kit may differ slightly from the exact materials shown in the video.\n  <\/div>\n{% endif %}","display_mode":"show_all"}},"liquid_UErA8z":{"type":"liquid","settings":{"title":"Product Bundles","liquid":"{% if template.name == 'product' and template.suffix == 'bundles' %}\n{%- assign initial_variant_id = product.selected_or_first_available_variant.id -%}\n\n<div id=\"bundle-ui\"\n     data-shop=\"{{ shop.permanent_domain }}\"\n     data-token=\"83e699c13152117e3e92c69d78070fec\"\n     data-product-gid=\"gid:\/\/shopify\/Product\/{{ product.id }}\"\n     data-initial-variant=\"{{ initial_variant_id }}\">\n  <div class=\"bb-head\">\n    <p class=\"bb-note\" role=\"note\">\n      When you hit “Add to Cart” it will add <strong>ALL<\/strong> of the flies listed below to your cart.\n      We recommend adjusting the quantities before adding them to your cart.\n    <\/p>\n  <\/div>\n\n  <!-- ✅ Top add-to-cart summary -->\n  <div class=\"bb-summary bb-summary--top\" aria-live=\"polite\">\n    <div class=\"bb-summary__left\">\n      <div class=\"bb-summary__line\"><span class=\"lbl\">Items<\/span><span class=\"bb-summary__items\">0<\/span><\/div>\n      <div class=\"bb-summary__line\"><span class=\"lbl\">Subtotal<\/span><span class=\"bb-summary__price\">$0.00<\/span><\/div>\n    <\/div>\n    <div class=\"bb-summary__right\">\n      <button id=\"bb-add-top\" class=\"bb-btn bb-add-all\" type=\"button\">Add All to Cart<\/button>\n    <\/div>\n  <\/div>\n\n<!-- Quick Qty toolbar -->\n  <div class=\"bb-quick\" role=\"group\" aria-label=\"Quick quantity actions\">\n    <span class=\"bb-quick__label\">Quick adjust all:<\/span>\n    <button class=\"bb-quick__btn\" type=\"button\" data-delta=\"-1\">-1<\/button>\n    <button class=\"bb-quick__btn\" type=\"button\" data-delta=\"1\">+1<\/button>\n    <button class=\"bb-quick__btn\" type=\"button\" data-delta=\"6\">+6<\/button>\n    <button class=\"bb-quick__btn\" type=\"button\" data-delta=\"12\">+12<\/button>\n    <button class=\"bb-quick__btn bb-quick__btn--muted\" type=\"button\" data-set=\"0\">Clear<\/button>\n  <\/div>\n\n  <div class=\"bb-divider\" aria-hidden=\"true\"><\/div>\n\n  <div id=\"bb-list\" class=\"bb-list\" aria-live=\"polite\"><\/div>\n\n  <!-- Totals (bottom) -->\n  <div class=\"bb-summary\" aria-live=\"polite\">\n    <div class=\"bb-summary__left\">\n      <div class=\"bb-summary__line\"><span class=\"lbl\">Items<\/span><span class=\"bb-summary__items\">0<\/span><\/div>\n      <div class=\"bb-summary__line\"><span class=\"lbl\">Subtotal<\/span><span class=\"bb-summary__price\">$0.00<\/span><\/div>\n    <\/div>\n    <div class=\"bb-summary__right\">\n      <button id=\"bb-add\" class=\"bb-btn bb-add-all\" type=\"button\">Add All to Cart<\/button>\n      <div id=\"bb-msg\" class=\"bb-msg\" aria-live=\"polite\"><\/div>\n    <\/div>\n  <\/div>\n\n  <div class=\"bb-divider bb-divider--bottom\" aria-hidden=\"true\"><\/div>\n<\/div>\n\n<style>\n  \/* Container *\/\n  #bundle-ui{ margin:0; contain:content; }\n  .bb-head{ display:flex; align-items:flex-start; gap:10px; margin:0; }\n  .bb-note{ margin:0; font-size:13px; line-height:1.4; color:#4a5568; }\n\n  \/* Dividers *\/\n  #bundle-ui .bb-divider{ height:1px; background:#e5e7eb; margin:12px 0; }\n\n  \/* List \/ rows *\/\n  #bundle-ui .bb-list{ display:flex; flex-direction:column; gap:10px; }\n  #bundle-ui .bb-row{\n    display:grid; grid-template-columns:64px 1fr 220px; gap:12px;\n    align-items:center; padding:12px; border:1px solid #ececec; border-radius:12px;\n    transition:background .15s ease; content-visibility:auto; contain-intrinsic-size:88px;\n    cursor:pointer; background:#fff;\n  }\n  #bundle-ui .bb-row:hover{ background:#fafafa; }\n  #bundle-ui .bb-imgwrap{ width:64px; height:64px; border-radius:10px; overflow:hidden; background:#f7f7f7; display:flex; align-items:center; justify-content:center; }\n  #bundle-ui .bb-img{ width:100%; height:100%; object-fit:cover; display:block; }\n  #bundle-ui .bb-meta{ display:flex; flex-direction:column; gap:4px; min-width:0; }\n  #bundle-ui .bb-name{ font-size:14px; font-weight:700; line-height:1.3; margin:0; }\n  #bundle-ui .bb-name a{ color:inherit; text-decoration:none; }\n  #bundle-ui .bb-name a:hover{ text-decoration:underline; }\n\n  \/* Selected options line *\/\n  #bundle-ui .bb-opts{ display:flex; flex-wrap:wrap; gap:6px 10px; margin:2px 0 0; font-size:12px; color:#535d6b; }\n  #bundle-ui .bb-opt strong{ font-weight:600; margin-right:4px; }\n\n  \/* Price line *\/\n  #bundle-ui .bb-price{ font-size:13px; color:#111827; display:flex; align-items:center; gap:8px; }\n  #bundle-ui .bb-price__cmp{ text-decoration:line-through; color:#6b7280; font-weight:400; }\n\n  \/* Stock *\/\n  #bundle-ui .bb-stock{ font-size:12px; font-weight:600; display:inline-flex; align-items:center; gap:6px; }\n  #bundle-ui .bb-stock--low{ color:#8a1212; }  #bundle-ui .bb-stock--ok{ color:#2b7a0b; }  #bundle-ui .bb-stock--out{ color:#8a1212; }\n\n  \/* Qty area (with stepper) *\/\n  #bundle-ui .bb-qty{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }\n  #bundle-ui .bb-qty label{ font-size:12px; color:#667085; }\n  #bundle-ui .bb-stepper{ display:inline-flex; align-items:stretch; border:1px solid #dcdcdc; border-radius:12px; overflow:hidden; background:#fff; }\n  #bundle-ui .bb-stepper button{\n    appearance:none; border:0; padding:10px 12px; background:#fff; cursor:pointer; font-weight:700; line-height:1;\n    min-width:44px; \/* mobile tap target *\/\n  }\n  #bundle-ui .bb-stepper input{\n    width:84px; padding:10px; border:0; text-align:center; font:inherit; border-left:1px solid #eee; border-right:1px solid #eee;\n  }\n\n  \/* Alt-variant UI (when original is sold out) *\/\n  #bundle-ui .bb-altwrap{ display:grid; grid-template-columns:max-content 1fr; column-gap:8px; row-gap:6px; align-items:center; margin-top:6px; }\n  #bundle-ui .bb-altlbl{ font-size:12px; color:#667085; white-space:nowrap; min-width:110px; }\n  #bundle-ui .bb-alt{ padding:6px 8px; border:1px solid #dcdcdc; border-radius:8px; font-size:12px; min-width:220px; width:100%; background:#fff; }\n  #bundle-ui .bb-alt option{ padding:8px 10px; line-height:1.6; }\n\n  \/* Quick qty toolbar *\/\n  #bundle-ui .bb-quick{ margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:12px; color:#4b5563; }\n  #bundle-ui .bb-quick__label{ font-weight:600; }\n  #bundle-ui .bb-quick__btn{ padding:6px 10px; border:1px solid #dcdcdc; background:#fff; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px; }\n  #bundle-ui .bb-quick__btn--muted{ color:#6b7280; }\n\n  \/* Totals \/ footer *\/\n  #bundle-ui .bb-summary{\n    margin-top:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:16px;\n    border:1px solid #ececec; border-radius:12px; background:#fcfcfc;\n  }\n  #bundle-ui .bb-summary__left{ display:flex; flex-direction:column; gap:6px; }\n  #bundle-ui .bb-summary__line{ display:flex; gap:12px; align-items:center; }\n  #bundle-ui .bb-summary__line .lbl{ width:72px; color:#6b7280; font-size:12px; }\n  #bundle-ui .bb-summary__items{ font-weight:700; font-size:16px; color:#374151; }\n  #bundle-ui .bb-summary__price{ font-weight:800; font-size:16px; color:#111827; }\n  #bundle-ui .bb-summary__right{ display:flex; align-items:center; gap:12px; min-width:auto; }\n  #bundle-ui .bb-btn{ appearance:none; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; background:#FF6C02; color:#fff; box-shadow:0 2px 0 rgba(0,0,0,.06); }\n  #bundle-ui .bb-btn:disabled{ opacity:.6; cursor:not-allowed; }\n  #bundle-ui .bb-msg{ font-size:12px; color:#46505f; min-height:18px; text-align:right; }\n\n  \/* Error box *\/\n  #bundle-ui .bb-err{ padding:10px; border:1px solid #f4cccc; background:#fff5f5; color:#a40000; border-radius:10px; margin:8px 0 0; }\n\n  \/* ===== Global modal styles (modal lives under <body>) ===== *\/\n  .bb-modal{ position:fixed; inset:0; display:none; place-items:center; z-index:9999; }\n  .bb-modal.is-open{ display:grid; }\n  .bb-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.5); }\n  .bb-modal__dialog{\n    position:relative; width:min(960px, 92vw); max-height:86vh; overflow:auto; background:#fff;\n    border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:18px;\n  }\n  .bb-modal__close{\n    position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:999px; border:0; cursor:pointer;\n    background:#f3f4f6; font-size:22px; line-height:1;\n  }\n  .bb-modal__content{ display:grid; grid-template-columns:360px 1fr; gap:16px; }\n  .bb-modal__imgwrap{ border-radius:12px; overflow:hidden; background:#f7f7f7; }\n  .bb-modal__img{ width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:1\/1; }\n  .bb-modal__title{ margin:0 0 4px; font-size:20px; font-weight:700; }\n  .bb-modal__opts{ margin:6px 0 6px; font-size:13px; color:#535d6b; display:flex; gap:10px; flex-wrap:wrap; }\n  .bb-modal__desc{ margin-top:8px; font-size:14px; color:#374151; }\n\n  \/* Phone \/ narrow *\/\n  @media (max-width: 760px){\n    .bb-modal__dialog{\n      width:100vw; height:100vh; max-height:100vh; border-radius:0;\n      padding:max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));\n    }\n    .bb-modal__content{ grid-template-columns:1fr; }\n    .bb-modal__img{ aspect-ratio:auto; max-height:42vh; object-fit:contain; }\n  }\n\n  \/* ===== Responsive cards (fix mobile qty) ===== *\/\n  @media (max-width: 720px){\n    #bundle-ui .bb-row{ grid-template-columns:56px 1fr; align-items:start; }\n    #bundle-ui .bb-qty{ grid-column:1 \/ -1; justify-content:space-between; padding-top:2px; }\n    #bundle-ui .bb-stepper input{ width:100px; } \/* bigger tap area *\/\n    #bundle-ui .bb-altwrap{ grid-template-columns:1fr; }\n    #bundle-ui .bb-alt{ min-width:0; }\n  }\n<\/style>\n\n<script>\n(() => {\n  const root = document.getElementById('bundle-ui');\n  if (!root) return;\n\n  const shop = root.dataset.shop;\n  const token = root.dataset.token;\n  const productGid = root.dataset.productGid;\n\n  const list = root.querySelector('#bb-list');\n  const msg = root.querySelector('#bb-msg');\n  const quick = root.querySelector('.bb-quick');\n  const sumItemsEls = document.querySelectorAll('.bb-summary__items'); \/\/ both summaries\n  const sumPriceEls = document.querySelectorAll('.bb-summary__price'); \/\/ both summaries\n\n  const endpoint = `https:\/\/${shop}\/api\/2025-07\/graphql.json`;\n  const gidToNum = gid => gid?.split('\/').pop();\n  const handleLink = (handle, variantGid) =>\n    handle ? `\/products\/${handle}?variant=${gidToNum(variantGid)}` : '#';\n\n  \/* Modal under <body> *\/\n  const modal = document.createElement('div');\n  modal.className = 'bb-modal';\n  modal.innerHTML = `\n    <div class=\"bb-modal__backdrop\" data-close><\/div>\n    <div class=\"bb-modal__dialog\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"bb-modal-title\">\n      <button class=\"bb-modal__close\" type=\"button\" aria-label=\"Close\" data-close>&times;<\/button>\n      <div class=\"bb-modal__content\"><\/div>\n    <\/div>`;\n  document.body.appendChild(modal);\n  const modalContent = modal.querySelector('.bb-modal__content');\n\n  \/* Maps *\/\n  const altMap = new Map();         \/\/ original variant id -> alternative variants\n  const productMap = new Map();     \/\/ product id -> { title, descriptionHtml, images[], handle, productType }\n  const variantInfoMap = new Map(); \/\/ variant id -> { productId, imageUrl, selectedOptions, title, priceAmt, cmpAmt, currency, qa, available }\n\n  function showError(text){ list.innerHTML = `<div class=\"bb-err\">${text}<\/div>`; }\n\n  async function gql(query, variables){\n    const res = await fetch(endpoint, {\n      method:'POST',\n      headers:{ 'Content-Type':'application\/json', 'X-Shopify-Storefront-Access-Token': token, 'Accept':'application\/json' },\n      body: JSON.stringify({ query, variables })\n    });\n    const text = await res.text();\n    let json = null; try { json = JSON.parse(text); } catch(e){}\n    if (!res.ok || (json && json.errors)){ throw new Error(text || `HTTP ${res.status}`); }\n    return json.data;\n  }\n\n  function stockBadge(qty, available){\n    if (qty === null || qty === undefined) return { text:'In stock', cls:'bb-stock--ok' };\n    if (qty <= 0 || available === false) return { text:'Sold out', cls:'bb-stock--out' };\n    if (qty <= 5) return { text:`${qty} in stock`, cls:'bb-stock--low' };\n    return { text:`${qty} in stock`, cls:'bb-stock--ok' };\n  }\n\n  const htmlOptions = (opts) =>\n    (opts || [])\n      .filter(o => o?.value && o.value !== 'Default Title')\n      .map(o => `<span class=\"bb-opt\"><strong>${o.name}:<\/strong> ${o.value}<\/span>`)\n      .join('');\n\n  const plainOptions = (opts) =>\n    (opts || [])\n      .filter(o => o?.value && o.value !== 'Default Title')\n      .map(o => `${o.name}: ${o.value}`)\n      .join('  ');\n\n  function captureVariantInfo(pv){\n    const product = pv?.product || {};\n    const productId = product.id;\n    if (productId && !productMap.has(productId)){\n      const imgs = (product?.images?.nodes || []).map(i => ({ url:i.url, alt:i.altText || '' }));\n      productMap.set(productId, {\n        title: product.title || '',\n        descriptionHtml: product.descriptionHtml || '',\n        images: imgs,\n        handle: product.handle || '',\n        productType: product.productType || ''\n      });\n    }\n    variantInfoMap.set(pv.id, {\n      productId,\n      imageUrl: pv?.image?.url || product?.featuredImage?.url || '',\n      selectedOptions: pv?.selectedOptions || [],\n      title: pv?.title || '',\n      priceAmt: Number(pv?.price?.amount || 0),\n      cmpAmt: pv?.compareAtPrice ? Number(pv.compareAtPrice.amount) : null,\n      currency: pv?.price?.currencyCode || null,\n      qa: Number.isFinite(pv?.quantityAvailable) ? pv.quantityAvailable : null,\n      available: pv?.availableForSale ?? true\n    });\n  }\n\n  function currencyFormatter(code){\n    try{ return new Intl.NumberFormat(undefined, { style:'currency', currency: code || 'USD' }); }\n    catch(e){ return new Intl.NumberFormat(undefined, { style:'currency', currency: 'USD' }); }\n  }\n\n  function updateTotals(){\n    let totalQty = 0;\n    let totalPrice = 0;\n    let currency = null;\n\n    list.querySelectorAll('input[type=\"number\"][data-gid]').forEach(inp => {\n      const qty = Math.max(0, parseInt(inp.value || '0', 10));\n      const info = variantInfoMap.get(inp.dataset.gid);\n      if (!info) return;\n      totalQty += qty;\n      totalPrice += qty * (info.priceAmt || 0);\n      if (!currency && info.currency) currency = info.currency;\n    });\n\n    const nf = currencyFormatter(currency);\n    sumItemsEls.forEach(el => el.textContent = String(totalQty));\n    sumPriceEls.forEach(el => el.textContent = nf.format(totalPrice));\n  }\n\n  function rowQtyInput(row){ return row.querySelector('input[type=\"number\"][data-gid]'); }\n\n  function clampToMax(inp, val){\n    const max = inp.dataset.max ? parseInt(inp.dataset.max,10) :\n      (inp.hasAttribute('max') ? parseInt(inp.getAttribute('max')||'0',10) : Infinity);\n    let v = Math.max(0, parseInt(val || '0', 10));\n    if (!Number.isFinite(v)) v = 0;\n    if (v > max) v = max;\n    return v;\n  }\n\n  function renderPriceLine(info){\n    const nf = currencyFormatter(info.currency);\n    const price = nf.format(info.priceAmt || 0);\n    if (info.cmpAmt && info.cmpAmt > (info.priceAmt || 0)){\n      const cmp = nf.format(info.cmpAmt);\n      return `<div class=\"bb-price\"><span class=\"bb-price__now\">${price}<\/span><span class=\"bb-price__cmp\">${cmp}<\/span><\/div>`;\n    }\n    return `<div class=\"bb-price\"><span class=\"bb-price__now\">${price}<\/span><\/div>`;\n  }\n\n  function renderFromVariants(variants){\n    if (!variants?.length){\n      showError('No variants found in metafield <code>custom.bundled_products<\/code>. Make sure it contains Product variants and has Storefront API access enabled.');\n      return;\n    }\n\n    altMap.clear(); productMap.clear(); variantInfoMap.clear();\n\n    \/\/ ✅ Sort by product type first, then title\n    variants.sort((a, b) => {\n      const typeA = (a.product?.productType || '').toLowerCase();\n      const typeB = (b.product?.productType || '').toLowerCase();\n      if (typeA < typeB) return -1;\n      if (typeA > typeB) return 1;\n\n      const titleA = (a.product?.title || '').toLowerCase();\n      const titleB = (b.product?.title || '').toLowerCase();\n      if (titleA < titleB) return -1;\n      if (titleA > titleB) return 1;\n\n      return 0;\n    });\n\n    list.innerHTML = variants.map(pv => {\n      captureVariantInfo(pv);\n\n      const pinfo = productMap.get(pv.product?.id);\n      const href = handleLink(pinfo?.handle, pv.id);\n\n      const imageUrl = pv?.image?.url || pv?.product?.featuredImage?.url || '';\n      const title = (pv?.product?.title || pv?.title || 'Item').replace(\/<\/g,'&lt;').replace(\/>\/g,'&gt;');\n\n      const info = variantInfoMap.get(pv.id);\n      const qa = info.qa;\n      const available = info.available;\n      const isSoldOut = (qa === 0 || available === false);\n      const stock = stockBadge(qa, available);\n\n      \/\/ alternatives (siblings)\n      const siblings = pv?.product?.variants?.nodes || [];\n      const alts = siblings.filter(v =>\n        v.id !== pv.id &&\n        (v.availableForSale ?? true) &&\n        (v.quantityAvailable == null || v.quantityAvailable > 0)\n      ).map(v => {\n        captureVariantInfo(v);\n        const vi = variantInfoMap.get(v.id);\n        return {\n          id: v.id,\n          qa: vi.qa,\n          imageUrl: vi.imageUrl || imageUrl,\n          selectedOptions: v.selectedOptions || [],\n          title: v.title\n        };\n      });\n      if (alts.length) altMap.set(pv.id, alts);\n\n      const optsHtml = htmlOptions(pv?.selectedOptions);\n      const altSelectHtml = (isSoldOut && alts.length)\n        ? `\n          <div class=\"bb-altwrap\">\n            <label class=\"bb-altlbl\" for=\"alt-${gidToNum(pv.id)}\">Choose alternative<\/label>\n            <select class=\"bb-alt\" id=\"alt-${gidToNum(pv.id)}\" data-key=\"${pv.id}\" aria-label=\"Choose alternative variant\">\n              <option value=\"\">-- Select option --<\/option>\n              ${alts.map(v => {\n                const text = plainOptions(v.selectedOptions) || v.title;\n                return `<option value=\"${v.id}\">${text}<\/option>`;\n              }).join('')}\n            <\/select>\n          <\/div>`\n        : '';\n\n      const maxAttr = qa !== null ? `max=\"${Math.max(0, qa)}\"` : '';\n      const dataMax = qa !== null ? `data-max=\"${Math.max(0, qa)}\"` : '';\n      const priceHtml = renderPriceLine(info);\n\n      return `\n        <div class=\"bb-row\" data-variant=\"${pv.id}\">\n          <div class=\"bb-imgwrap\" aria-hidden=\"true\">\n            ${imageUrl ? `<img class=\"bb-img\" alt=\"${(pv?.image?.altText || title).replace(\/\"\/g,'&quot;')}\" src=\"${imageUrl}&width=320&height=320&crop=center\">` : ''}\n          <\/div>\n          <div class=\"bb-meta\">\n            <p class=\"bb-name\">\n              <a href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\" onclick=\"window.open('${href}','_blank');return false;\">\n                ${title}\n              <\/a>\n            <\/p>\n            ${optsHtml ? `<div class=\"bb-opts\" aria-label=\"Selected options\">${optsHtml}<\/div>` : ''}\n            ${priceHtml}\n            <div class=\"bb-stock ${stock.cls}\" aria-live=\"polite\">${stock.text}<\/div>\n            ${altSelectHtml}\n          <\/div>\n          <div class=\"bb-qty\">\n            <label for=\"qty-${gidToNum(pv.id)}\">Qty<\/label>\n            <div class=\"bb-stepper\" aria-label=\"Adjust quantity\">\n              <button class=\"bb-step\" type=\"button\" data-step=\"-1\" aria-label=\"Decrease quantity\">−<\/button>\n              <input id=\"qty-${gidToNum(pv.id)}\" type=\"number\" min=\"0\" ${maxAttr} ${dataMax}\n                     value=\"${isSoldOut ? 0 : 1}\" data-gid=\"${pv.id}\"\n                     ${isSoldOut ? 'disabled' : ''} inputmode=\"numeric\" pattern=\"[0-9]*\">\n              <button class=\"bb-step\" type=\"button\" data-step=\"1\" aria-label=\"Increase quantity\">+<\/button>\n            <\/div>\n          <\/div>\n        <\/div>\n      `;\n    }).join('');\n\n    updateTotals();\n  }\n\n  \/* Delegated handlers *\/\n\n  \/\/ Clamp qty + update totals\n  list.addEventListener('input', (e) => {\n    const inp = e.target;\n    if (!(inp instanceof HTMLInputElement) || inp.type !== 'number' || !inp.dataset.gid) return;\n    const v = clampToMax(inp, inp.value);\n    if (String(v) !== inp.value) inp.value = String(v);\n    updateTotals();\n  });\n\n  \/\/ Stepper buttons\n  list.addEventListener('click', (e) => {\n    const stepBtn = e.target.closest('.bb-step'); if (!stepBtn) return;\n    const row = stepBtn.closest('.bb-row'); if (!row) return;\n    const inp = rowQtyInput(row); if (!inp || inp.disabled) return;\n\n    const step = parseInt(stepBtn.dataset.step || '0', 10);\n    const next = clampToMax(inp, Math.max(0, (parseInt(inp.value||'0',10)||0) + step));\n    inp.value = String(next);\n    updateTotals();\n  });\n\n  \/\/ Choose alternative -> update row + link + totals\n  list.addEventListener('change', (e) => {\n    const sel = e.target;\n    if (!(sel instanceof HTMLSelectElement) || !sel.classList.contains('bb-alt')) return;\n    const chosenId = sel.value; if (!chosenId) return;\n\n    requestAnimationFrame(() => {\n      const row = sel.closest('.bb-row'); if (!row) return;\n\n      const key = sel.dataset.key;\n      const alts = altMap.get(key) || [];\n      const chosen = alts.find(a => a.id === chosenId);\n      if (!chosen) return;\n\n      const qty = rowQtyInput(row);\n      qty.dataset.gid = chosen.id;\n\n      const stockEl = row.querySelector('.bb-stock');\n      const info = stockBadge(chosen.qa, true);\n      stockEl.textContent = info.text;\n      stockEl.className = 'bb-stock ' + info.cls;\n\n      if (Number.isFinite(chosen.qa)) {\n        qty.max = String(Math.max(0, chosen.qa));\n        qty.dataset.max = String(Math.max(0, chosen.qa));\n      } else {\n        qty.removeAttribute('max');\n        qty.removeAttribute('data-max');\n      }\n      if (chosen.qa === 0) {\n        qty.value = '0'; qty.disabled = true;\n      } else {\n        if (parseInt(qty.value || '0', 10) === 0) qty.value = '1';\n        qty.disabled = false;\n      }\n\n      \/\/ Update options + image + title link\n      const optsEl = row.querySelector('.bb-opts'); if (optsEl) optsEl.innerHTML = htmlOptions(chosen.selectedOptions);\n      const img = row.querySelector('img.bb-img'); if (img && chosen.imageUrl) img.src = chosen.imageUrl + '&width=320&height=320&crop=center';\n\n      \/\/ Update name link to the chosen variant's parent product page (via handle)\n      const chosenInfo = variantInfoMap.get(chosen.id);\n      const chosenProd = chosenInfo ? productMap.get(chosenInfo.productId) : null;\n      const newHref = handleLink(chosenProd?.handle, chosen.id);\n      const a = row.querySelector('.bb-name a');\n      if (a) {\n        a.setAttribute('href', newHref);\n        a.setAttribute('onclick', `window.open('${newHref}','_blank');return false;`);\n      }\n\n      updateTotals();\n    });\n  });\n\n  \/\/ Open modal on card click (ignore interactive elements)\n  list.addEventListener('click', (e) => {\n    if (e.target.closest('input, select, button, label, a')) return;\n    const row = e.target.closest('.bb-row');\n    if (!row) return;\n    const currentVariantGid = row.querySelector('input[data-gid]')?.dataset.gid || row.dataset.variant;\n    openModal(currentVariantGid);\n  });\n\n  \/\/ Quick qty buttons\n  quick.addEventListener('click', (e) => {\n    const btn = e.target.closest('.bb-quick__btn'); if (!btn) return;\n    const inputs = list.querySelectorAll('input[type=\"number\"][data-gid]:not(:disabled)');\n    if (btn.dataset.set !== undefined){\n      inputs.forEach(inp => { inp.value = '0'; });\n      updateTotals();\n      return;\n    }\n    const delta = parseInt(btn.dataset.delta || '0', 10);\n    inputs.forEach(inp => {\n      const next = clampToMax(inp, Math.max(0, (parseInt(inp.value||'0',10)||0) + delta));\n      inp.value = String(next);\n    });\n    updateTotals();\n  });\n\n  \/\/ Modal helpers\n  function openModal(variantId){\n    const vinfo = variantInfoMap.get(variantId);\n    if (!vinfo) return;\n    const pinfo = productMap.get(vinfo.productId) || { title:'', descriptionHtml:'', images:[], handle:'' };\n\n    const mainImg = vinfo.imageUrl || (pinfo.images[0]?.url || '');\n    const optsHtml = htmlOptions(vinfo.selectedOptions);\n    const href = handleLink(pinfo.handle, variantId);\n\n    modalContent.innerHTML = `\n      <div class=\"bb-modal__imgwrap\">\n        ${mainImg ? `<img class=\"bb-modal__img\" alt=\"${(pinfo.title || 'Product image').replace(\/\"\/g,'&quot;')}\" src=\"${mainImg}\">` : ''}\n      <\/div>\n      <div>\n        <h3 id=\"bb-modal-title\" class=\"bb-modal__title\">\n          <a href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\" onclick=\"window.open('${href}','_blank');return false;\">${pinfo.title}<\/a>\n        <\/h3>\n        ${optsHtml ? `<div class=\"bb-modal__opts\">${optsHtml}<\/div>` : ''}\n        <div class=\"bb-modal__desc\">${pinfo.descriptionHtml || ''}<\/div>\n      <\/div>\n    `;\n    modal.classList.add('is-open');\n    document.documentElement.style.overflow = 'hidden';\n    modal.querySelector('.bb-modal__close').focus();\n  }\n  function closeModal(){\n    modal.classList.remove('is-open');\n    document.documentElement.style.overflow = '';\n  }\n  modal.addEventListener('click', (e) => { if (e.target.hasAttribute('data-close')) closeModal(); });\n  window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal(); });\n\n  async function loadFromMetafield(){\n    const addBtns = document.querySelectorAll('.bb-add-all');\n    addBtns.forEach(b => b.disabled = true);\n    if (msg) msg.textContent = 'Loading bundle…';\n\n    \/\/ Pull referenced variants from metafield custom.bundled_products\n    const data = await gql(\n      `query($id:ID!, $ns:String!, $key:String!){\n        product(id:$id){\n          id\n          metafield(namespace:$ns, key:$key){\n            reference{\n              __typename\n              ... on ProductVariant {\n                id title availableForSale quantityAvailable\n                price{ amount currencyCode }\n                compareAtPrice{ amount currencyCode }\n                selectedOptions{ name value }\n                image{ url altText }\n                product{\n                  id title productType descriptionHtml handle\n                  featuredImage{ url altText }\n                  images(first:10){ nodes{ url altText } }\n                  variants(first:50){\n                    nodes{\n                      id title availableForSale quantityAvailable\n                      price{ amount currencyCode }\n                      compareAtPrice{ amount currencyCode }\n                      selectedOptions{ name value }\n                      image{ url altText }\n                    }\n                  }\n                }\n              }\n            }\n            references(first:50){\n              nodes{\n                __typename\n                ... on ProductVariant {\n                  id title availableForSale quantityAvailable\n                  price{ amount currencyCode }\n                  compareAtPrice{ amount currencyCode }\n                  selectedOptions{ name value }\n                  image{ url altText }\n                  product{\n                    id title productType descriptionHtml handle\n                    featuredImage{ url altText }\n                    images(first:10){ nodes{ url altText } }\n                    variants(first:50){\n                      nodes{\n                        id title availableForSale quantityAvailable\n                        price{ amount currencyCode }\n                        compareAtPrice{ amount currencyCode }\n                        selectedOptions{ name value }\n                        image{ url altText }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }`,\n      { id: productGid, ns: \"custom\", key: \"bundled_products\" }\n    ).catch(err => { showError('Could not load metafield <code>custom.bundled_products<\/code>. Check Storefront API access.'); throw err; });\n\n    const mf = data?.product?.metafield;\n    if (!mf){\n      showError('Metafield <code>custom.bundled_products<\/code> not found on this product.');\n      if (msg) msg.textContent = '';\n      addBtns.forEach(b => b.disabled = true);\n      return;\n    }\n\n    const listNodes = mf?.references?.nodes?.filter(n => n?.__typename === 'ProductVariant') || [];\n    let variants = listNodes;\n    if (!variants.length && mf?.reference?.__typename === 'ProductVariant'){ variants = [mf.reference]; }\n\n    renderFromVariants(variants);\n    if (msg) msg.textContent = '';\n    addBtns.forEach(b => b.disabled = false);\n  }\n\n  \/\/ Add all to cart (both top & bottom)\n  document.querySelectorAll('.bb-add-all').forEach(btn => {\n    btn.addEventListener('click', async () => {\n      const addBtns = document.querySelectorAll('.bb-add-all');\n      if (msg) msg.textContent = '';\n      addBtns.forEach(b => b.disabled = true);\n\n      const inputs = list.querySelectorAll('input[data-gid]');\n      const items = [];\n      inputs.forEach(inp => {\n        const id = Number(gidToNum(inp.dataset.gid));\n        const q = Math.max(0, parseInt(inp.value || '0', 10));\n        if (Number.isFinite(id) && q > 0) items.push({ id, quantity: q });\n      });\n\n      if (!items.length) {\n        if (msg) msg.textContent = 'Please choose at least one item.';\n        addBtns.forEach(b => b.disabled = false);\n        return;\n      }\n\n      try {\n        const res = await fetch('\/cart\/add.js', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application\/json', 'Accept': 'application\/json' },\n          body: JSON.stringify({ items })\n        });\n        if (!res.ok) throw new Error(await res.text());\n        window.location.href = '\/cart';\n      } catch(e) {\n        console.error(e);\n        if (msg) msg.textContent = 'Sorry — we couldn’t add the items to your cart.';\n        addBtns.forEach(b => b.disabled = false);\n      }\n    });\n  });\n\n  \/\/ Init\n  loadFromMetafield();\n})();\n<\/script>\n{% endif %}","display_mode":"show_all"}},"description":{"type":"description","settings":{"display_mode":"show_all"}},"affirm_pay_over_time_messaging_product_block_J43hNW":{"type":"shopify:\/\/apps\/affirm-pay-over-time-messaging\/blocks\/product-block\/6dce54be-130d-4d13-9636-1e8f611b3071","settings":{"logo_align":"left","font_size":16,"logo_color":"blue","logo_type":"logo","public_api_key":"","price_selector":""}},"value_props_MA4aHt":{"type":"value_props","settings":{"shipping_text":"Free Shipping over $49*","show_shipping_link":false,"shipping_link":"","price_text":"Low Price Guarantee","show_price_link":false,"price_link":"","returns_text":"Easy Returns","show_returns_link":false,"returns_link":""}}},"block_order":["product_meta","yotpo_product_reviews_star_rating_9JAHkD","bundle_summary_FmEU64","liquid_ttm9gb","liquid_UErA8z","description","affirm_pay_over_time_messaging_product_block_J43hNW","value_props_MA4aHt"],"settings":{"image_size":"large","enable_video_looping":false,"enable_image_zoom":true,"zoom_effect":"popup","carousel_effect":"fade"}},"product-recommendations":{"type":"product-recommendations","settings":{"heading":"You may also like","show_quick_buy":false}},"recently-viewed-products":{"type":"recently-viewed-products","settings":{"title":"Recently viewed","show_quick_buy":false}},"175508935922c5dfb5":{"type":"apps","settings":{"include_margins":true}}},"order":["main","product-recommendations","recently-viewed-products","175508935922c5dfb5"]}