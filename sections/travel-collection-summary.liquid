{% comment %}
  Travel Collection Summary Section
  Displays an intro/summary section with heading and body text
{% endcomment %}

{%- liquid
  assign summary_content = collection.metafields.travel.summary
  assign has_custom_format = false
  assign heading_part = ''
  assign summary_part = ''

  # Check if metafield exists and has value
  if summary_content.value != blank
    # Check if it's a rich_text_field type with structured content
    if summary_content.type == 'rich_text_field'
      # Try to parse structured content
      assign first_node = summary_content.value.children.first

      # Check if first node is a heading
      if first_node.type == 'heading'
        assign has_custom_format = true
        # Extract heading text from first node
        for child in first_node.children
          assign heading_part = heading_part | append: child.value
        endfor

        # Get remaining content as summary
        assign summary_html = summary_content | metafield_tag
        assign summary_part = summary_html | strip_html | strip
        # Remove the heading from summary
        assign summary_part = summary_part | remove_first: heading_part | strip
      endif
    endif

    # Fallback: Check if using custom format with markers
    unless has_custom_format
      assign summary_html = summary_content.value
      if summary_html contains 'Heading:' and summary_html contains 'Summary:'
        assign has_custom_format = true

        # Split on Summary: to separate heading and content
        assign parts = summary_html | split: 'Summary:'

        # Extract heading (remove "Heading:" prefix and HTML tags)
        assign heading_raw = parts[0] | strip_html | remove: 'Heading:' | strip
        assign heading_part = heading_raw

        # Extract summary content (remove HTML tags but keep text)
        assign summary_raw = parts[1] | strip_html | strip
        assign summary_part = summary_raw
      endif
    endunless
  endif

  # Use defaults if not using custom format
  unless has_custom_format
    assign heading_part = section.settings.default_heading
    assign summary_part = summary_content | metafield_text
  endunless
-%}

<style>
  .travel-summary {
    background-color: #E7E9EB;
    padding: 60px 20px;
  }

  .travel-summary__container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .travel-summary__header {
    display: flex;
    align-items: center;
    margin-bottom: 24px;
  }

  .travel-summary__accent {
    width: 8px;
    height: 8px;
    background-color: #3E90C5;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .travel-summary__heading {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #000000;
    margin: 0;
  }

  .travel-summary__content {
    font-size: 20px;
    line-height: 1.6;
    color: #000000;
    margin-bottom: 32px;
  }

  .travel-summary__content p {
    margin-bottom: 24px;
  }

  .travel-summary__content p:last-child {
    margin-bottom: 0;
  }

  .travel-summary__callout {
    background-color: #3E90C5;
    color: #FFFFFF;
    padding: 16px 24px;
    display: inline-block;
    font-size: 16px;
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .travel-summary {
      padding: 40px 20px;
    }

    .travel-summary__content {
      font-size: 18px;
    }

    .travel-summary__callout {
      display: block;
      text-align: center;
    }
  }
</style>

<section class="travel-summary">
  <div class="travel-summary__container">

    <div class="travel-summary__header">
      <div class="travel-summary__accent"></div>
      <h2 class="travel-summary__heading">
        {% if heading_part != blank %}
          {{ heading_part }}
        {% else %}
          {{ section.settings.default_heading }}
        {% endif %}
      </h2>
    </div>

    {% if summary_part != blank %}
      <div class="travel-summary__content">
        <p>{{ summary_part }}</p>
      </div>
    {% elsif section.settings.default_content != blank %}
      <div class="travel-summary__content">
        {{ section.settings.default_content }}
      </div>
    {% endif %}

    {% if section.settings.show_callout %}
      <div class="travel-summary__callout">
        {{ section.settings.callout_text }}
      </div>
    {% endif %}

  </div>
</section>

{% schema %}
{
  "name": "Travel Summary",
  "class": "travel-collection-summary-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "paragraph",
      "content": "Summary content is pulled from collection.metafields.travel.summary (rich text). Format: 'Heading: [content] Summary: [content]'"
    },
    {
      "type": "text",
      "id": "default_heading",
      "label": "Default heading",
      "default": "INTRO HEADLINE"
    },
    {
      "type": "richtext",
      "id": "default_content",
      "label": "Default content",
      "default": "<p>Add your collection summary content here.</p>"
    },
    {
      "type": "header",
      "content": "Callout Box"
    },
    {
      "type": "checkbox",
      "id": "show_callout",
      "label": "Show callout box",
      "default": true
    },
    {
      "type": "text",
      "id": "callout_text",
      "label": "Callout text",
      "default": "Trip planning is free. Price-match guaranteed."
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Travel Collection Summary"
    }
  ]
}
{% endschema %}
